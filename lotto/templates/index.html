<!doctype html><html lang="ko"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>로또 대시보드</title>
<link rel="stylesheet" href="/static/main.css">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;margin:0;padding:0;background:#fafafa;color:#222}
  header{padding:16px 20px;background:#111;color:#fff}
  main{padding:16px 20px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .span2{grid-column:1 / span 2}
  h1{margin:0;font-size:20px}
  h2{margin:8px 0 12px;font-size:18px}
  h3{margin:6px 0;font-size:15px}
  button{padding:8px 12px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
  input[type=number]{width:120px;padding:6px;border:1px solid #ddd;border-radius:8px}
  .table-wrap{border:1px solid #eee;border-radius:10px;overflow:auto;background:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 10px;border-bottom:1px solid #f0f0f0;white-space:nowrap}
  th{position:sticky;top:0;background:#f9f9f9}
  .nums{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
</style>
</head>
<body>
<header><h1>로또 대시보드 (최신 회차: {{ latest_draw }})</h1></header>
<main>
  <div id="status-line" style="margin:6px 0 10px;"><span id="msg" style="color:#444;"></span></div>

  <section>
    <h2>최근 10회 당첨번호</h2>
    <div class="table-wrap" style="margin-top:8px;">
      <table class="sticky">
        <thead><tr><th>#</th><th>회차</th><th>추첨일</th><th>번호(6)</th><th>보너스</th></tr></thead>
        <tbody id="recent-draws-body"></tbody>
      </table>
    </div>
  </section>

  <section>
    <h2>회차 당첨번호 단건 조회</h2>
    <div class="spin-wrap" style="display:inline-flex;gap:4px;align-items:center;">
      <button type="button" id="spin-draw-prev">◀</button>
      <input id="draw-input" type="number" placeholder="회차 입력" min="1" max="{{ latest_draw }}" value="{{ latest_draw }}" step="1">
      <button type="button" id="spin-draw-next">▶</button>
      <button type="button" id="spin-draw-latest">최신</button>
      <button id="btn-draw">회차 조회</button>
    </div>
    <div class="table-wrap" style="margin-top:8px;">
      <table class="sticky">
        <thead><tr><th>회차</th><th>추첨일</th><th>번호(6)</th><th>보너스</th></tr></thead>
        <tbody id="draw-body"></tbody>
      </table>
    </div>
  </section>

  <section>
    <h2>1등 당첨점</h2>
    <div class="spin-wrap" style="display:inline-flex;gap:4px;align-items:center;">
      <button type="button" id="spin-shop-prev">◀</button>
      <input id="shop-draw-input" type="number" placeholder="회차 입력" min="1" max="{{ latest_draw }}" value="{{ latest_draw }}" step="1">
      <button type="button" id="spin-shop-next">▶</button>
      <button type="button" id="spin-shop-latest">최신</button>
      <button id="btn-load-draw-shops">해당 회차 판매점</button>
      <button id="btn-load-latest-shops">최신 회차 판매점</button>
    </div>
    <div class="table-wrap" style="margin-top:8px;">
      <table class="sticky">
        <thead><tr><th>#</th><th>점포</th><th>방법</th><th>주소</th></tr></thead>
        <tbody id="shops-body"></tbody>
      </table>
    </div>
  </section>

  <section class="span2">
    <h2>최근 추천 (자동 6개 ×5 + 반자동 3개 ×5)</h2>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px;">
      <div>
        <h3>자동 번호 6개 (최근 5)</h3>
        <div class="table-wrap"><table class="sticky">
          <thead><tr><th>#</th><th>회차</th><th>번호(6)</th><th>생성시각</th></tr></thead>
          <tbody id="recent-auto6-body">
            {% for r in recent_auto6 %}
              <tr><td>{{ loop.index }}</td><td>{{ r['week_no'] }}</td><td class="nums">{{ r['numbers'] }}</td><td>{{ r['created_at'] }}</td></tr>
            {% endfor %}
          </tbody>
        </table></div>
      </div>
      <div>
        <h3>반자동 3개 (최근 5)</h3>
        <div class="table-wrap"><table class="sticky">
          <thead><tr><th>#</th><th>회차</th><th>번호(3)</th><th>생성시각</th></tr></thead>
          <tbody id="recent-semi-body">
            {% for r in recent_semi %}
              <tr><td>{{ loop.index }}</td><td>{{ r['week_no'] }}</td><td class="nums">{{ r['numbers'] }}</td><td>{{ r['created_at'] }}</td></tr>
            {% endfor %}
          </tbody>
        </table></div>
      </div>
    </div>
  </section>

  <section class="span2">
    <h2>회차별 추천 목록</h2>
    <div class="actions" style="margin:8px 0;">
      <input id="reco-draw" type="number" min="1" placeholder="회차" style="width:120px;padding:6px;border:1px solid #ddd;border-radius:8px;">
      <button id="btn-reco-load">불러오기</button>
    </div>
    <div class="table-wrap">
      <table class="sticky">
        <thead><tr><th>#</th><th>알고리즘</th><th>추천번호</th><th>확신도</th><th>사유</th><th>생성시각</th></tr></thead>
        <tbody id="reco-body">
          <tr id="reco-empty-hint" style="display:none;"><td colspan="6" style="text-align:center;color:#666;">
            추천 이력이 없습니다. <button id="btn-reco-create-this">이 회차 생성</button>
          </td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="span2">
    <h2>검증 결과</h2>
    <div class="actions" style="margin:8px 0;">
      <input id="res-draw" type="number" min="1" placeholder="회차" style="width:120px;padding:6px;border:1px solid #ddd;border-radius:8px;">
      <button id="btn-res-load">불러오기</button>
      <button id="btn-res-csv">CSV 다운로드</button>
    </div>
    <div class="table-wrap">
      <table class="sticky">
        <thead><tr><th>#</th><th>알고리즘</th><th>추천번호</th><th>일치</th><th>보너스</th><th>등수</th><th>생성시각</th></tr></thead>
        <tbody id="res-body"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  const msg = document.getElementById("msg"); const setMsg=(t)=>{ try{ if(msg) msg.textContent=t; }catch(e){} }; const setMsg=(t)=>{ if(msg) msg.textContent=t; };
  const drawBody = document.getElementById("draw-body");
  const shopsBody = document.getElementById("shops-body");
  const btnDraw = document.getElementById("btn-draw");
  const btnLoadShops = document.getElementById("btn-load-draw-shops");
  const btnLoadLatestShops = document.getElementById("btn-load-latest-shops");
  const drawInput = document.getElementById("draw-input");
  const shopDrawInput = document.getElementById("shop-draw-input");

  const recoBody = document.getElementById("reco-body");
  const resBody  = document.getElementById("res-body");
  const btnRecoLoad = document.getElementById("btn-reco-load");
  const btnResLoad  = document.getElementById("btn-res-load");
  const btnResCsv   = document.getElementById("btn-res-csv");
  const inputRecoDraw = document.getElementById("reco-draw");
  const inputResDraw  = document.getElementById("res-draw");
  const LATEST = {{ latest_draw|int }};
  if(inputRecoDraw) inputRecoDraw.value = LATEST;
  if(inputResDraw)  inputResDraw.value  = LATEST;

  function wrapDraw(v){ v=parseInt(v||0,10); if(isNaN(v)) return LATEST; if(v<1) return LATEST; if(v> LATEST) return 1; return v; }

  function renderDraw(d){
    drawBody.innerHTML = "";
    if(!d || !d.success){ return; }
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.draw_no}</td><td>${d.draw_date||""}</td><td class="nums">${(d.numbers||[]).join(",")}</td><td>${d.bonus??""}</td>`;
    drawBody.appendChild(tr);
  }
  function renderShops(draw_no, shops){
    shopsBody.innerHTML = "";
    (shops||[]).forEach((s,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${s.shop??""}</td><td>${s.method??""}</td><td>${s.address??""}</td>`;
      shopsBody.appendChild(tr);
    });
  }

  btnDraw.onclick = async () => {
    let v = wrapDraw(drawInput.value);
    setMsg( `회차 ${v} 불러오는 중...`;
    const r = await fetch(`/api/draw/${v}`); const j = await r.json();
    renderDraw(j)); setMsg( j.success ? "완료" : "실패";
  };

  btnLoadShops.onclick = async () => {
    let v = wrapDraw(shopDrawInput.value);
    setMsg( `회차 ${v} 1등 판매점 불러오는 중...`;
    const r = await fetch(`/api/winshops/${v}`); const j = await r.json();
    renderShops(j.draw_no, j.shops)); setMsg( `회차 ${j.draw_no} 판매점 ${j.count}개`;
  };

  btnLoadLatestShops.onclick = async () => {
    setMsg( "최신 회차 1등 판매점 불러오는 중...";
    const r = await fetch(`/api/winshops/latest`); const j = await r.json();
    if (j && j.draw_no) shopDrawInput.value = j.draw_no;
    renderShops(j.draw_no, j.shops)); setMsg( `회차 ${j.draw_no} 판매점 ${j.count}개`;
  };

  function renderReco(list){
    const hint=document.getElementById("reco-empty-hint");
    while (recoBody.firstChild) recoBody.removeChild(recoBody.firstChild);
    if(!list || list.length===0){
      if(hint){ hint.style.display="table-row"; recoBody.appendChild(hint); }
      return;
    }
    if(hint) hint.style.display="none";
    list.forEach((r,i)=>{
      const tr=document.createElement("tr");
      const slot = r.slot? ` #${r.slot}`:"";
      tr.innerHTML = `<td>${i+1}</td><td>${r.algorithm}${slot}</td><td class="nums">${r.numbers}</td><td>${r.confidence??""}</td><td>${r.reason??""}</td><td>${r.created_at}</td>`;
      recoBody.appendChild(tr);
    });
  }
  function renderResults(list){
    resBody.innerHTML = "";
    list.forEach((r,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${r.algorithm}</td><td class="nums">${r.numbers}</td><td>${r.matched}</td><td>${r.bonus}</td><td>${r.rank}</td><td>${r.generated_at}</td>`;
      resBody.appendChild(tr);
    });
  }

  async function loadRecentRecs(){
    try{
      const r = await fetch("/api/recommendations/recent"); const j = await r.json();
      const A = document.getElementById("recent-auto6-body");
      const B = document.getElementById("recent-semi-body");
      const a = j.auto6||[], b = j.semi_auto||[];
      if(A) A.innerHTML = a.map((x,i)=>`<tr><td>${i+1}</td><td>${x.week_no}</td><td class="nums">${x.numbers}</td><td>${x.created_at}</td></tr>`).join("");
      if(B) B.innerHTML = b.map((x,i)=>`<tr><td>${i+1}</td><td>${x.week_no}</td><td class="nums">${x.numbers}</td><td>${x.created_at}</td></tr>`).join("");
    }catch(e){}
  }

  // 추천 생성/검증 버튼
  btnRecoNext.onclick = async () => {
    setMsg( "다음 회차 추천 생성 중...";
    const r = await fetch("/api/recommendations/generate", {method:"POST"});
    const j = await r.json();
    if(j.success){
      setMsg( "완료!";
      await loadRecentRecs();
      const rd=document.getElementById("reco-draw"); const btn=document.getElementById("btn-reco-load");
      if(rd && btn){ rd.value = ({{ latest_draw|int }} + 1); btn.click(); }
    } else setMsg( "실패";
  };
  btnValidate.onclick = async () => {
    let v = wrapDraw(drawInput.value);
    setMsg( `회차 ${v} 검증 중...`;
    const r = await fetch(`/api/recommendations/validate/${v}`, {method:"POST"});
    const j = await r.json();
    setMsg( j.success ? "검증 완료!" : "검증 실패";
  };

  // 회차별 추천/검증 로더
  btnRecoLoad.onclick = async ()=>{
    const d = parseInt(inputRecoDraw.value||"0",10);
    if(!d){ msg.textContent="회차 입력"; return; }
    setMsg( "추천 불러오는 중...";
    const r = await fetch(`/api/recommendations/${d}`); const j = await r.json();
    if(j.success){ renderReco(j.items||[])); setMsg( `회차 ${d} 추천 ${j.count}건`; }
    else setMsg( "실패";
  };
  btnResLoad.onclick = async ()=>{
    const d = parseInt(inputResDraw.value||"0",10);
    if(!d){ msg.textContent="회차 입력"; return; }
    setMsg( "검증결과 불러오는 중...";
    const r = await fetch(`/api/recommendations/results/${d}`); const j = await r.json();
    if(j.success){ renderResults(j.items||[]); msg.textContent=`회차 ${d} 결과 ${j.count}건`; }
    else msg.textContent="실패";
  };
  btnResCsv.onclick = ()=>{ const d = parseInt(inputResDraw.value||"0",10); if(!d) return; window.open(`/api/recommendations/results/${d}/csv`,"_blank"); };

  // 스핀(◀/▶/최신) 버튼
  function spinAttach(idPrev,idInput,idNext,idLatest){
    const p=document.getElementById(idPrev), i=document.getElementById(idInput), n=document.getElementById(idNext), l=document.getElementById(idLatest);
    if(!i) return;
    const wrap=(v)=>{ v=parseInt(v||'',10); if(isNaN(v)) return LATEST; if(v<1) return LATEST; if(v> LATEST) return 1; return v; };
    p && (p.onclick=()=>{ let v=parseInt(i.value||'',10); if(isNaN(v)) v=LATEST; i.value=(v<=1?LATEST:v-1); });
    n && (n.onclick=()=>{ let v=parseInt(i.value||'',10); if(isNaN(v)) v=LATEST; i.value=(v>=LATEST?1:v+1); });
    l && (l.onclick=()=>{ i.value = LATEST; });
    i.addEventListener("change", ()=>{ i.value = wrap(i.value); });
    i.addEventListener("wheel", (e)=>{ e.preventDefault(); }, {passive:false});
  }
  spinAttach("spin-draw-prev","draw-input","spin-draw-next","spin-draw-latest");
  spinAttach("spin-shop-prev","shop-draw-input","spin-shop-next","spin-shop-latest");

  async function loadRecentDraws(){
    try{
      const r = await fetch("/api/draw/recent?limit=10"); const j = await r.json();
      const body = document.getElementById("recent-draws-body");
      if(!body) return;
      body.innerHTML = (j.items||[]).map((x,i)=>(
        `<tr><td>${i+1}</td><td>${x.draw_no}</td><td>${x.draw_date||""}</td><td class="nums">${(x.numbers||[]).join(",")}</td><td>${x.bonus??""}</td></tr>`
      )).join("");
    }catch(e){}
  }

  // 최초 로드
  (async ()=>{
    await loadRecentRecs();
    await loadRecentDraws();
    const rd=document.getElementById("reco-draw"); const btn=document.getElementById("btn-reco-load");
    if(rd && btn){ if(!rd.value) rd.value = LATEST; btn.click(); }
  })();
</script>
