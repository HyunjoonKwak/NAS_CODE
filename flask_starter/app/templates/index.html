{% extends "base.html" %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<input type="hidden" id="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
<script>
  window.csrfToken = '{{ csrf_token() }}';
</script>

<div class="header">
  <div class="title-section">
    <h1>🏠 대시보드</h1>
    <div class="muted">로또 분석 및 추천 시스템</div>
  </div>
  <div class="date-section">
    <div class="current-date" id="currentDate"></div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Latest Draw Results -->
  {% if latest %}
  <section class="card highlight-card">
    <div class="card-header">
      <h2>🎯 {{ latest.round }}회 최신 추첨결과</h2>
      <div class="header-actions">
        <span class="draw-date">{{ latest.draw_date if latest.draw_date else '' }}</span>
        <button id="checkNewDrawBtn" class="btn-update" onclick="checkForNewDraw()">
          새 회차 확인
        </button>
        <a href="https://dhlottery.co.kr/gameResult.do?method=byWin" target="_blank" class="btn-lotto-site">
          🎲 로또구매
        </a>
      </div>
    </div>

    <!-- 새 회차 알림 -->
    <div id="newDrawAlert" class="new-draw-alert" style="display: none;">
      <div class="alert-content">
        <span class="alert-icon">⚡</span>
        <span class="alert-message">새로운 회차가 추첨되었을 수 있습니다!</span>
        <button onclick="checkForNewDraw()" class="alert-btn">지금 확인하기</button>
      </div>
    </div>
    <div class="draw-result">
      <div class="numbers">
        {% for num in latest.numbers_list() %}
          <span class="number-ball">{{ num }}</span>
        {% endfor %}
      </div>
      <div class="bonus-section">
        <span class="plus">+</span>
        <span class="bonus-ball">{{ latest.bonus }}</span>
        <span class="bonus-label">보너스</span>
      </div>
    </div>
  </section>
  {% else %}
  <section class="card error-card">
    <h2>⚠️ 데이터 없음</h2>
    <p>추첨 결과 데이터가 없습니다. 정보조회 페이지에서 데이터를 업데이트해주세요.</p>
  </section>
  {% endif %}



  <!-- Latest Winning Shops -->
  {% if latest and shops_rank1 %}
  <section class="card">
    <div class="card-header">
      <h2>🏪 {{ latest.round }}회 1등 당첨점 ({{ shops_rank1|length }}개)</h2>
    </div>

    {% if shops_rank1|length > 0 %}
    <div class="table-container">
      <table>
        <thead>
          <tr><th>순번</th><th>상호</th><th>구분</th><th>주소</th></tr>
        </thead>
        <tbody>
          {% for s in shops_rank1 %}
          <tr>
            <td>{{ s.sequence or '' }}</td>
            <td><strong>{{ s.name }}</strong></td>
            <td><span class="badge-method">{{ s.method or '구분없음' }}</span></td>
            <td>{{ s.address }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="info-box">
      <p>아직 1등 당첨점 정보가 없습니다.</p>
    </div>
    {% endif %}

    <div style="margin-top: 1rem; text-align: center;">
      <p><small>더 자세한 당첨점 정보는 <a href="{{ url_for('main.info_page') }}">정보조회 페이지</a>에서 확인하세요.</small></p>
    </div>
  </section>
  {% endif %}

</div> <!-- End main-content -->

<style>
/* 헤더 스타일 */
.title-section {
  flex: 1;
}

.date-section {
  text-align: right;
}

.current-date {
  font-size: 0.9rem;
  color: #666;
  font-weight: 500;
}

/* 새 회차 알림 스타일 */
.new-draw-alert {
  background: linear-gradient(135deg, #ff6b6b, #ffa726);
  color: white;
  border-radius: 0.5rem;
  margin: 1rem 0;
  padding: 0;
  overflow: hidden;
  animation: slideDown 0.3s ease;
}

.alert-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
}

.alert-icon {
  font-size: 1.5rem;
}

.alert-message {
  flex: 1;
  font-weight: 500;
}

.alert-btn {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 0.5rem 1rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
}

.alert-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.btn-update {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.btn-update:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.btn-update:disabled {
  background: #6c757d;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-lotto-site {
  background: linear-gradient(135deg, #e74c3c, #c0392b);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  white-space: nowrap;
  display: inline-block;
}

.btn-lotto-site:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
  color: white;
  text-decoration: none;
}

@media (max-width: 768px) {
  .header-actions {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }

  .draw-date {
    order: 2;
  }

  .btn-update {
    order: 1;
    align-self: flex-end;
  }

  .btn-lotto-site {
    order: 1;
    align-self: flex-end;
    margin-top: 0.5rem;
  }
}
</style>

<script>
// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
  // 오늘 날짜 표시
  const today = new Date();
  const dateStr = today.toLocaleDateString('ko-KR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'long'
  });
  document.getElementById('currentDate').textContent = dateStr;

  // 새 회차 확인 유도
  checkIfNewDrawNeeded();
});

// 새 회차 확인이 필요한지 체크
function checkIfNewDrawNeeded() {
  const drawDateText = document.querySelector('.draw-date').textContent.trim();
  if (!drawDateText) return;

  // 추첨날짜 파싱 (YYYY-MM-DD 형식 가정)
  const drawDate = new Date(drawDateText);
  const today = new Date();
  const daysDiff = Math.floor((today - drawDate) / (1000 * 60 * 60 * 24));

  // 추첨 후 7일이 지났으면 새 회차 확인 알림 표시
  if (daysDiff >= 7) {
    const alertDiv = document.getElementById('newDrawAlert');
    if (alertDiv) {
      alertDiv.style.display = 'block';
    }
  }
}

async function checkForNewDraw() {
  const button = document.getElementById('checkNewDrawBtn');
  const originalText = button.innerHTML;

  button.disabled = true;
  button.innerHTML = '<span class="spinner">⏳</span> 확인중...';

  try {
    // 새로운 회차가 있는지 확인
    const response = await fetch('/api/check-new-draw');
    const data = await response.json();

    if (data.has_new_draw) {
      const confirmed = confirm(`새로운 ${data.latest_round}회 추첨 결과가 있습니다. 업데이트하시겠습니까?`);

      if (confirmed) {
        button.innerHTML = '<span class="spinner">⏳</span> 업데이트중...';

        // 최신 회차 데이터 업데이트
        const updateResponse = await fetch('/api/update-new-draw', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            round: data.latest_round,
            csrf_token: window.csrfToken
          })
        });

        const updateData = await updateResponse.json();

        if (updateData.success) {
          alert(`${data.latest_round}회 추첨 결과가 업데이트되었습니다!`);
          // 페이지 새로고침
          window.location.reload();
        } else {
          alert(`업데이트 실패: ${updateData.message}`);
        }
      }
    } else {
      alert('새로운 추첨 결과가 없습니다.');
    }
  } catch (error) {
    console.error('Error checking for new draw:', error);
    alert('확인 중 오류가 발생했습니다.');
  } finally {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}
</script>

{% endblock %}
