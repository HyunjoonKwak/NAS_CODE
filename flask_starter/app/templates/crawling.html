{% extends "base.html" %}

{% block content %}
<div class="header">
  <div>
    <h1>📥 데이터 크롤링</h1>
    <div class="muted">로또 데이터 수집 및 업데이트</div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="main-content">

  <!-- Data Collection Panel -->
  <section id="data-collection" class="card actions-card">
    <div class="card-header">
      <h2>🔄 로또 데이터 크롤링</h2>
    </div>

    <div class="action-groups-vertical">
      <!-- Progress Status - 위쪽으로 이동 -->
      <section class="card progress-card" id="progress-section">
        <div class="card-header">
          <h3>⚡ 크롤링 진행 상태</h3>
        </div>
        <div id="progress-container">
          <div class="progress-status">
            <div class="status-text" id="status-text">대기중</div>
            <div class="operation-type" id="operation-type"></div>
          </div>
          <div class="progress-details" id="progress-details" style="display: none;">
            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div class="progress-text" id="progress-text">0%</div>
            </div>
            <div class="round-info">
              <span id="current-round-info">현재: -</span>
              <span id="total-rounds-info">전체: -</span>
            </div>
            <div class="time-info">
              <span id="elapsed-time">경과: 0초</span>
              <span id="remaining-time" style="display: none;">예상 남은 시간: -</span>
            </div>
          </div>
        </div>
      </section>

      <!-- 크롤링 옵션 선택 -->
      <div class="crawling-type-selector">
        <h4>크롤링 데이터 선택</h4>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="both" checked>
            <span class="radio-label">당첨번호 + 판매점 (전체)</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="numbers">
            <span class="radio-label">당첨번호만</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="crawling-type" value="shops">
            <span class="radio-label">판매점만</span>
          </label>
        </div>
      </div>

      <div class="action-group">
        <div class="crawling-grid">
          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">1</span>
              <h4>전체 다시 크롤링</h4>
            </div>
            <p class="option-desc">1회차부터 최신회차까지 모든 데이터를 다시 수집합니다</p>
            <button type="button" class="btn-primary" onclick="startCrawling('full')">실행</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">2</span>
              <h4>빠진회차 크롤링</h4>
            </div>
            <p class="option-desc">누락된 회차만 선별하여 데이터를 수집합니다</p>
            <button type="button" class="btn-secondary" onclick="startCrawling('missing')">실행</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">3</span>
              <h4>최신회차 크롤링</h4>
            </div>
            <p class="option-desc">가장 최근 추첨회차 데이터만 업데이트합니다</p>
            <button type="button" class="btn-secondary" onclick="startCrawling('latest')">실행</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">4</span>
              <h4>범위 크롤링</h4>
            </div>
            <p class="option-desc">지정한 회차 범위의 데이터를 수집합니다</p>
            <div class="range-input">
              <input type="number" id="startRound" min="1" placeholder="시작 회차" />
              <span>~</span>
              <input type="number" id="endRound" min="1" placeholder="끝 회차" />
            </div>
            <button type="button" class="btn-secondary" onclick="startRangeCrawling()">실행</button>
          </div>

          <div class="crawling-option">
            <div class="option-header">
              <span class="option-number">5</span>
              <h4>특정회차 크롤링</h4>
            </div>
            <p class="option-desc">원하는 회차를 지정하여 해당 데이터만 수집합니다</p>
            <div class="specific-round-input">
              <input type="number" id="specificRound" min="1" placeholder="회차 번호" />
              <button type="button" class="btn-secondary" onclick="startSpecificCrawling()">실행</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Status Information -->
  <section class="card">
    <div class="card-header">
      <h2>📊 데이터 현황</h2>
    </div>
    <div class="info-grid">
      <div class="info-item">
        <h4>저장된 회차</h4>
        <p>{{ total_rounds }}회</p>
      </div>
      {% if latest %}
      <div class="info-item">
        <h4>최신 회차</h4>
        <p>{{ latest.round }}회</p>
      </div>
      {% endif %}
    </div>
  </section>

</div> <!-- End main-content -->

<style>
.crawling-type-selector {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 1.5rem;
}

.crawling-type-selector h4 {
  margin-bottom: 0.8rem;
  color: #333;
  font-size: 1.1rem;
  font-weight: 600;
}

.radio-group {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-weight: 600;
  color: #333;
}

.radio-option input[type="radio"] {
  margin: 0;
  transform: scale(1.1);
}

.crawling-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-top: 1rem;
}

.crawling-option {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 0.5rem;
  padding: 1.2rem;
  transition: all 0.3s ease;
}

.crawling-option:hover {
  border-color: #667eea;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
}

.option-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.option-number {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2rem;
  height: 2rem;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  font-weight: bold;
  border-radius: 50%;
  font-size: 1rem;
}

.option-header h4 {
  margin: 0;
  color: #333;
  font-size: 1.1rem;
}

.option-desc {
  color: #666;
  margin-bottom: 1.2rem;
  line-height: 1.4;
  font-size: 0.9rem;
}

.range-input {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.range-input input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
}

.range-input span {
  font-weight: bold;
  color: #666;
}

.specific-round-input {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.specific-round-input input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
}

.btn-primary, .btn-secondary {
  width: 100%;
  padding: 0.8rem 1.2rem;
  border: none;
  border-radius: 0.4rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.95rem;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #5a6268;
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
}

.specific-round-input .btn-secondary {
  width: auto;
  padding: 0.5rem 1rem;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-top: 1rem;
}

.info-item {
  text-align: center;
  padding: 2rem;
  background: #f8f9fa;
  border-radius: 0.5rem;
}

.info-item h4 {
  margin: 0 0 0.5rem 0;
  color: #666;
  font-size: 1rem;
}

.info-item p {
  margin: 0;
  font-size: 2rem;
  font-weight: bold;
  color: #333;
}

/* Progress Card Styles */
.progress-card {
  background: #fff;
  margin-bottom: 1.5rem;
}

.progress-card .card-header h3 {
  margin: 0;
  font-size: 1.3rem;
  color: #333;
}

/* Progress Status Styles */
.progress-status {
  text-align: center;
  margin-bottom: 1rem;
}

.status-text {
  font-size: 1.5rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 0.5rem;
}

.operation-type {
  font-size: 1rem;
  color: #666;
  font-weight: 500;
}

.progress-details {
  margin-top: 1.5rem;
}

.progress-bar-container {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.progress-bar {
  flex: 1;
  height: 20px;
  background: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  border-radius: 10px;
  transition: width 0.5s ease;
  width: 0%;
}

.progress-text {
  font-weight: bold;
  color: #333;
  min-width: 50px;
}

.round-info, .time-info {
  display: flex;
  justify-content: space-between;
  margin: 0.5rem 0;
  font-size: 0.9rem;
  color: #666;
}

.round-info span, .time-info span {
  font-weight: 500;
}

@media (max-width: 768px) {
  .crawling-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .radio-group {
    flex-direction: column;
    gap: 0.8rem;
  }

  .crawling-option {
    padding: 1rem;
  }

  .info-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .range-input {
    flex-direction: column;
    align-items: stretch;
    gap: 0.5rem;
  }

  .specific-round-input {
    flex-direction: column;
    gap: 0.5rem;
  }

  .specific-round-input .btn-secondary {
    width: 100%;
  }

  .crawling-type-selector {
    padding: 0.8rem;
  }

  .progress-card .card-header h3 {
    font-size: 1.2rem;
  }

  .status-text {
    font-size: 1.3rem;
  }
}
</style>

<script>
let progressInterval;
let lastUpdateTime = 0;

function formatTime(seconds) {
  if (seconds < 60) return `${seconds}초`;
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  return `${minutes}분 ${remainingSeconds}초`;
}

function getCrawlingType() {
  const checkedRadio = document.querySelector('input[name="crawling-type"]:checked');
  return checkedRadio ? checkedRadio.value : 'both';
}

function startCrawling(type) {
  const crawlingType = getCrawlingType();
  const url = `/update-${type}`;

  const formData = new FormData();
  formData.append('data_type', crawlingType);

  fetch(url, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`오류: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Crawling error:', error);
    startProgressMonitoring();
  });

  startProgressMonitoring();
}

function startRangeCrawling() {
  const startRound = document.getElementById('startRound').value;
  const endRound = document.getElementById('endRound').value;
  const crawlingType = getCrawlingType();

  if (!startRound || !endRound) {
    alert('시작 회차와 끝 회차를 모두 입력해주세요.');
    return;
  }

  if (parseInt(startRound) > parseInt(endRound)) {
    alert('시작 회차가 끝 회차보다 클 수 없습니다.');
    return;
  }

  const formData = new FormData();
  formData.append('start', startRound);
  formData.append('end', endRound);
  formData.append('data_type', crawlingType);

  fetch('/update-range', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`오류: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Range crawling error:', error);
    startProgressMonitoring();
  });

  startProgressMonitoring();
}

function startSpecificCrawling() {
  const round = document.getElementById('specificRound').value;
  const crawlingType = getCrawlingType();

  if (!round) {
    alert('회차 번호를 입력해주세요.');
    return;
  }

  const formData = new FormData();
  formData.append('round', round);
  formData.append('data_type', crawlingType);

  fetch('/update', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (response.redirected) {
      window.location.href = response.url;
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(`오류: ${data.error}`);
    }
  })
  .catch(error => {
    console.error('Specific crawling error:', error);
    startProgressMonitoring();
  });

  startProgressMonitoring();
}

function updateProgress() {
  const currentTime = Date.now();

  // 너무 빈번한 업데이트 방지 (최소 500ms 간격)
  if (currentTime - lastUpdateTime < 500) {
    return;
  }

  lastUpdateTime = currentTime;

  fetch('/api/crawling-progress')
    .then(response => response.json())
    .then(data => {
      const statusText = document.getElementById('status-text');
      const operationType = document.getElementById('operation-type');
      const progressDetails = document.getElementById('progress-details');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      const currentRoundInfo = document.getElementById('current-round-info');
      const totalRoundsInfo = document.getElementById('total-rounds-info');
      const elapsedTime = document.getElementById('elapsed-time');
      const remainingTime = document.getElementById('remaining-time');

      // 상태 텍스트 업데이트 (깜빡임 방지)
      if (statusText.textContent !== data.status) {
        statusText.textContent = data.status;
      }

      const operationText = data.operation_type ? `[${data.operation_type}]` : '';
      if (operationType.textContent !== operationText) {
        operationType.textContent = operationText;
      }

      if (data.is_running) {
        // 진행 상황 표시
        progressDetails.style.display = 'block';

        // 진행률 계산 및 업데이트
        const percentage = data.total_rounds > 0 ?
          Math.round((data.completed_rounds / data.total_rounds) * 100) : 0;

        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;

        // 회차 정보 업데이트
        currentRoundInfo.textContent = `현재: ${data.current_round}회`;
        totalRoundsInfo.textContent = `전체: ${data.total_rounds}회 (완료: ${data.completed_rounds})`;

        // 시간 정보 업데이트
        if (data.elapsed_seconds) {
          elapsedTime.textContent = `경과: ${formatTime(data.elapsed_seconds)}`;
        }

        if (data.estimated_remaining_seconds && data.estimated_remaining_seconds > 0) {
          remainingTime.textContent = `예상 남은 시간: ${formatTime(data.estimated_remaining_seconds)}`;
          remainingTime.style.display = 'inline';
        } else {
          remainingTime.style.display = 'none';
        }
      } else {
        // 크롤링 완료 또는 대기 상태
        if (data.status !== '대기중') {
          // 완료 상태 잠시 표시 후 숨김
          setTimeout(() => {
            if (!document.querySelector('#status-text').textContent.includes('진행중')) {
              progressDetails.style.display = 'none';
            }
          }, 3000);
        } else {
          progressDetails.style.display = 'none';
        }

        // 크롤링 완료시 진행 모니터링 중지
        if (data.status.includes('완료') || data.status === '대기중') {
          stopProgressMonitoring();
        }
      }
    })
    .catch(error => {
      console.error('Progress update error:', error);
      // 에러 발생시 잠시 후 재시도
      setTimeout(updateProgress, 2000);
    });
}

function startProgressMonitoring() {
  if (progressInterval) {
    clearInterval(progressInterval);
  }

  // 즉시 한 번 업데이트
  updateProgress();

  // 주기적 업데이트 (1초 간격)
  progressInterval = setInterval(updateProgress, 1000);
}

function stopProgressMonitoring() {
  if (progressInterval) {
    clearInterval(progressInterval);
    progressInterval = null;
  }
}

// 페이지 로드시 진행 상태 확인
document.addEventListener('DOMContentLoaded', function() {
  updateProgress();

  // 진행 중인 작업이 있으면 모니터링 시작
  setTimeout(() => {
    const statusText = document.getElementById('status-text').textContent;
    if (statusText.includes('진행중') || statusText.includes('수집중')) {
      startProgressMonitoring();
    }
  }, 500);
});

// 페이지 언로드시 정리
window.addEventListener('beforeunload', function() {
  stopProgressMonitoring();
});
</script>
{% endblock %}
