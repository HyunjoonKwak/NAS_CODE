{% extends "mobile/base.html" %}

{% block title %}모바일 대시보드{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<input type="hidden" id="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
<script>
  window.csrfToken = '{{ csrf_token() }}';
</script>

<!-- 모바일 헤더 -->
<div class="mobile-header">
  <div class="title">
    <h1>🎯 로또 대시보드</h1>
    <div class="subtitle">분석 및 추천 시스템</div>
  </div>

  <!-- 현재 시간 및 카운트다운 -->
  <div class="time-section">
    <div class="current-time" id="currentTime"></div>
    <div class="countdown" id="nextDrawCountdown"></div>
  </div>
</div>

<!-- 새 회차 알림 (모바일용) -->
<div class="mobile-alert" id="newDrawAlert" style="display: none;">
  <div class="alert-content">
    <span class="alert-icon">⚡</span>
    <span class="alert-text" id="alertMessage">새로운 회차가 추첨되었을 수 있습니다!</span>
  </div>
  <button class="alert-btn" onclick="checkForNewDraw()">지금 확인하기</button>
</div>

<!-- 최신 추첨 결과 -->
{% if latest %}
<div class="mobile-card">
  <div class="card-header">
    <h2>{{ latest.round }}회 최신 결과</h2>
    <span class="draw-date">{{ latest.draw_date if latest.draw_date else '' }}</span>
  </div>

  <div class="numbers-section">
    <div class="numbers">
      {% for num in latest.numbers_list() %}
      <span class="number">{{ num }}</span>
      {% endfor %}
    </div>
    <div class="bonus-section">
      <span class="plus">+</span>
      <span class="bonus number">{{ latest.bonus }}</span>
      <span class="bonus-label">보너스</span>
    </div>
  </div>

  <div class="mobile-actions">
    <button class="btn-primary" id="checkNewDrawBtn" onclick="checkForNewDraw()">
      새 회차 확인
    </button>
    <a href="https://dhlottery.co.kr/gameResult.do?method=byWin" target="_blank" class="btn-lotto">
      🎲 로또구매
    </a>
  </div>
</div>
{% else %}
<div class="mobile-card error">
  <h2>⚠️ 데이터 없음</h2>
  <p>추첨 결과가 없습니다.<br>정보조회에서 데이터를 업데이트해주세요.</p>
</div>
{% endif %}

<!-- 당첨점 정보 -->
{% if latest and shops_rank1 %}
<div class="mobile-card">
  <div class="card-header">
    <h2>🏪 {{ latest.round }}회 1등 당첨점</h2>
    <span class="count">{{ shops_rank1|length }}개</span>
  </div>

  {% if shops_rank1|length > 0 %}
  <div class="shops-list">
    {% for shop in shops_rank1[:3] %}
    <div class="shop-item">
      <div class="shop-name">{{ shop.name }}</div>
      <div class="shop-method">{{ shop.method or '구분없음' }}</div>
      <div class="shop-address">{{ shop.address }}</div>
    </div>
    {% endfor %}
    {% if shops_rank1|length > 3 %}
    <div class="more-shops">
      외 {{ shops_rank1|length - 3 }}개 더보기 →
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endif %}

<!-- 빠른 메뉴 -->
<div class="mobile-card">
  <div class="card-header">
    <h2>🔗 빠른 메뉴</h2>
  </div>

  <div class="quick-menu">
    <a href="{{ url_for('main.strategy') }}" class="menu-item">
      <span class="menu-icon">📊</span>
      <span class="menu-text">전략분석</span>
    </a>
    <a href="{{ url_for('main.purchase_history') }}" class="menu-item">
      <span class="menu-icon">🛒</span>
      <span class="menu-text">구매내역</span>
    </a>
    <a href="{{ url_for('main.info_page') }}" class="menu-item">
      <span class="menu-icon">📋</span>
      <span class="menu-text">정보조회</span>
    </a>
    <a href="{{ url_for('main.crawling_page') }}" class="menu-item">
      <span class="menu-icon">🔄</span>
      <span class="menu-text">데이터수집</span>
    </a>
  </div>
</div>

<!-- 데스크톱 버전 링크 -->
<div class="desktop-link">
  <a href="/?desktop=1" class="link-desktop">
    🖥️ 데스크톱 버전으로 보기
  </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// 모바일용 시간 업데이트 함수
function updateCurrentTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('ko-KR', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
  const dateStr = now.toLocaleDateString('ko-KR', {
    month: 'long',
    day: 'numeric',
    weekday: 'short'
  });
  document.getElementById('currentTime').textContent = `${dateStr} ${timeStr}`;
}

// 모바일용 카운트다운 함수
function updateCountdown() {
  const now = new Date();

  // 다음 토요일 8시 45분 계산
  let nextSaturday = new Date(now);
  const daysUntilSaturday = (6 - now.getDay()) % 7;

  if (now.getDay() === 6) {
    if (now.getHours() < 20 || (now.getHours() === 20 && now.getMinutes() < 45)) {
      nextSaturday.setHours(20, 45, 0, 0);
    } else {
      nextSaturday.setDate(now.getDate() + 7);
      nextSaturday.setHours(20, 45, 0, 0);
    }
  } else {
    nextSaturday.setDate(now.getDate() + (daysUntilSaturday === 0 ? 7 : daysUntilSaturday));
    nextSaturday.setHours(20, 45, 0, 0);
  }

  const timeDiff = nextSaturday - now;

  if (timeDiff <= 0) {
    document.getElementById('nextDrawCountdown').innerHTML = '<span class="countdown-icon">🎯</span><span class="countdown-text">추첨 진행중</span>';
    return;
  }

  const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

  let countdownHtml = '<span class="countdown-icon">🎯</span>';

  if (days > 0) {
    countdownHtml += `<span class="countdown-text">다음 추첨까지<br>${days}일 ${hours}시간</span>`;
  } else {
    if (hours > 0) {
      countdownHtml += `<span class="countdown-text">다음 추첨까지<br>${hours}시간 ${minutes}분</span>`;
    } else if (minutes > 0) {
      countdownHtml += `<span class="countdown-text">다음 추첨까지<br>${minutes}분 ${seconds}초</span>`;
    } else {
      countdownHtml += `<span class="countdown-text">${seconds}초 후<br>추첨 시작!</span>`;
    }
  }

  document.getElementById('nextDrawCountdown').innerHTML = countdownHtml;
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
  updateCurrentTime();
  updateCountdown();

  setInterval(() => {
    updateCurrentTime();
    updateCountdown();
  }, 1000);

  checkIfNewDrawNeeded();
});

// 새 회차 확인이 필요한지 체크 (일반 페이지와 동일한 로직 적용)
function checkIfNewDrawNeeded() {
  const drawDateText = document.querySelector('.draw-date');
  if (!drawDateText || !drawDateText.textContent.trim()) return;

  // 추첨날짜 파싱 (YYYY-MM-DD 형식 가정)
  const drawDate = new Date(drawDateText.textContent.trim());
  const today = new Date();

  // 한국 시간 기준으로 계산 (KST)
  const now_kst = new Date();

  // 로또 추첨 시간: 매주 토요일 오후 8시 45분 (KST)
  // 1회차 추첨일: 2002년 12월 7일 (토요일)
  const first_draw_date = new Date(2002, 11, 7); // 월은 0부터 시작
  const weeks_since_first = Math.floor((now_kst - first_draw_date) / (1000 * 60 * 60 * 24 * 7));

  // 현재 주의 토요일 8시 45분 계산
  const days_until_saturday = (5 - now_kst.getDay()) % 7;  // 0=월요일, 5=토요일
  let current_saturday;
  
  if (now_kst.getDay() === 5) {  // 현재가 토요일이면
    current_saturday = new Date(now_kst);
    current_saturday.setHours(0, 0, 0, 0);
  } else {
    current_saturday = new Date(now_kst);
    current_saturday.setDate(now_kst.getDate() + days_until_saturday);
    current_saturday.setHours(0, 0, 0, 0);
  }

  const draw_time = new Date(current_saturday);
  draw_time.setHours(20, 45, 0, 0);  // 오후 8시 45분

  // 현재 시간이 이번 주 추첨 시간을 지났는지 확인
  const draw_completed_this_week = now_kst >= draw_time;

  // 예상 회차 계산 (1회차는 2002년 12월 7일)
  let expected_round;
  if (draw_completed_this_week) {
    expected_round = weeks_since_first + 1;
  } else {
    expected_round = weeks_since_first;
  }

  // 마지막 추첨에서 다음 추첨 시간이 지났는지 확인
  const weeks_since_last_draw = Math.floor((today - drawDate) / (1000 * 60 * 60 * 24 * 7));
  const should_have_new_draw = weeks_since_last_draw >= 1 && draw_completed_this_week;

  if (should_have_new_draw) {
    const alertDiv = document.getElementById('newDrawAlert');
    const alertMessage = document.getElementById('alertMessage');
    
    if (alertDiv && alertMessage) {
      alertDiv.style.display = 'block';
      
      // 다음 추첨 시간 계산
      const next_draw_time = draw_completed_this_week ? 
        new Date(draw_time.getTime() + (7 * 24 * 60 * 60 * 1000)) : // 다음 주 토요일
        draw_time; // 이번 주 토요일

      const hours_left = Math.max(0, Math.floor((next_draw_time - now_kst) / (1000 * 60 * 60)));
      
      if (hours_left > 0) {
        alertMessage.textContent = `새로운 회차가 추첨되었을 수 있습니다! (다음 추첨: ${hours_left}시간 후)`;
      } else {
        alertMessage.textContent = '새로운 회차가 추첨되었을 수 있습니다!';
      }
    }
  }
}

// 새 회차 확인 함수 (일반 페이지와 동일한 로직 적용)
async function checkForNewDraw() {
  const button = document.getElementById('checkNewDrawBtn');
  const originalText = button.innerHTML;

  button.disabled = true;
  button.innerHTML = '<span class="spinner">⏳</span> 확인중...';

  try {
    // 새로운 회차가 있는지 확인
    const response = await fetch('/api/check-new-draw');
    const data = await response.json();

    // 상세한 메시지 먼저 표시
    let alertMessage = data.message || '새로운 추첨 결과가 없습니다.';

    // 추가 정보가 있으면 포함 (모바일에서는 간소화)
    if (data.draw_completed && data.next_draw_time) {
      const nextDrawDate = new Date(data.next_draw_time);
      const formattedTime = nextDrawDate.toLocaleDateString('ko-KR', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      alertMessage += `\n다음 추첨: ${formattedTime}`;
    } else if (!data.draw_completed && data.hours_until_draw > 0) {
      alertMessage += `\n(${data.hours_until_draw}시간 후 추첨)`;
    }

    if (data.has_new_draw) {
      // 추첨 완료 여부에 따른 다른 확인 메시지 (모바일 최적화)
      let confirmMessage;
      if (data.draw_completed) {
        confirmMessage = `🎯 ${data.latest_round}회 추첨이 완료되었습니다!\n\n새로운 결과를 업데이트하시겠습니까?`;
      } else {
        confirmMessage = `📈 ${data.latest_round}회 결과를 확인했습니다.\n\n지금 업데이트하시겠습니까?`;
      }

      const confirmed = confirm(confirmMessage);

      if (confirmed) {
        button.innerHTML = '<span class="spinner">⏳</span> 업데이트중...';

        // 최신 회차 데이터 업데이트
        const updateResponse = await fetch('/api/update-new-draw', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            round: data.latest_round,
            csrf_token: window.csrfToken
          })
        });

        const updateData = await updateResponse.json();

        if (updateData.success) {
          alert(`✅ ${data.latest_round}회 추첨 결과가 업데이트되었습니다!`);
          // 알림 숨기기
          const alertDiv = document.getElementById('newDrawAlert');
          if (alertDiv) {
            alertDiv.style.display = 'none';
          }
          // 페이지 새로고침
          window.location.reload();
        } else {
          alert(`❌ 업데이트 실패: ${updateData.message}`);
        }
      }
    } else {
      alert(alertMessage);
    }
  } catch (error) {
    console.error('Error checking for new draw:', error);
    alert('❌ 확인 중 오류가 발생했습니다.');
  } finally {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}
</script>
{% endblock %}
