{% extends "base.html" %}
{% block content %}

<!-- 상단: 최신 회차 정보 + 업데이트 버튼 -->
<div class="card mb-3 shadow-sm">
  <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
      <h4 class="m-0">
        {% if latest_draw %}
          최신 회차: <strong>{{ latest_draw.round }}회</strong>
          <span class="text-muted ms-2">({{ latest_draw.draw_date }})</span>
        {% else %}
          최신 회차: <strong>없음</strong>
        {% endif %}
      </h4>
      {% if latest_draw %}
        <div class="mt-2">
          당첨번호:
          <strong>{{ latest_draw.n1 }}, {{ latest_draw.n2 }}, {{ latest_draw.n3 }}, {{ latest_draw.n4 }}, {{ latest_draw.n5 }}, {{ latest_draw.n6 }}</strong>
          <span class="ms-2">보너스: <strong>{{ latest_draw.bonus }}</strong></span>
        </div>
      {% endif %}
      <div class="text-muted small mt-2">총 수집 회차: {{ total_count }}</div>
    </div>
    <div class="d-flex gap-2">
      <form method="post" action="{{ url_for('dashboard.update_now') }}">
        <button class="btn btn-outline-primary">신규 회차 업데이트</button>
      </form>
    </div>
  </div>
</div>

<div class="row g-3">

  <!-- 추천 번호 + 이유 (캐시된 세트) -->
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="card-title m-0">추천 번호 <span class="text-muted">(회차별 캐시)</span></h5>
          <form method="post" action="{{ url_for('dashboard.refresh_recommend') }}">
            <button class="btn btn-primary">새로 추천</button>
          </form>
        </div>

        {% if not has_recommend %}
          <div class="alert alert-info">
            아직 이 회차에 대한 추천이 생성되지 않았습니다. <strong>새로 추천</strong> 버튼을 눌러 생성하세요.
          </div>
        {% else %}
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted">전체 조합 5개</h6>
              <ol class="mb-0">
                {% for combo, reason in full_with_reason %}
                  <li class="mb-1">
                    <strong>{{ combo|join(', ') }}</strong>
                    <div class="small text-muted">이유: {{ reason }}</div>
                  </li>
                {% endfor %}
              </ol>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">반자동(3개 추천) 5세트</h6>
              <ol class="mb-0">
                {% for triple in semi %}
                  <li class="mb-1"><strong>{{ triple|join(', ') }}</strong> + 자유선택 3개</li>
                {% endfor %}
              </ol>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- 최근 10회차 -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">최근 10회차</h5>
        <table class="table table-sm">
          <thead><tr><th>회차</th><th>추첨일</th><th>번호</th><th>보너스</th></tr></thead>
          <tbody>
          {% for d in recent %}
            <tr>
              <td>{{ d.round }}</td>
              <td>{{ d.draw_date }}</td>
              <td>{{ d.n1 }}, {{ d.n2 }}, {{ d.n3 }}, {{ d.n4 }}, {{ d.n5 }}, {{ d.n6 }}</td>
              <td>{{ d.bonus }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 빈출 / 콜드 / 마지막 출현 -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">분석 요약</h5>

        <div class="row">
          <div class="col-md-6">
            <h6>상위 빈출 번호</h6>
            <ol class="mb-3">
              {% for n,c in singles %}
                <li>{{ n }} ({{ c }}회)</li>
              {% endfor %}
            </ol>
          </div>
          <div class="col-md-6">
            <h6>콜드 번호 (최근 안 나옴)</h6>
            <ol class="mb-3">
              {% for n,last,delta in colds %}
                <li>
                  {{ n }}
                  <span class="text-muted small">
                    - 마지막 {{ last if last else '없음' }}회 / 경과 {{ delta }}회
                  </span>
                </li>
              {% endfor %}
            </ol>
          </div>
        </div>

        <h6 class="mt-2">마지막 출현 회차(1~45)</h6>
        <div class="small text-muted">
          {% for n in range(1,46) %}
            {{ '%02d' % n }}: {{ lastmap.get(n,0) }}{% if not loop.last %}, {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- 페어 상위 10 -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">페어 빈도 TOP 10</h5>
        <table class="table table-sm">
          <thead><tr><th>#</th><th>조합</th><th>빈도</th></tr></thead>
          <tbody>
            {% for pair,count in pairs %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ pair[0] }}, {{ pair[1] }}</td>
                <td>{{ count }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 당첨점 조회 -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">1등 당첨점 조회</h5>
        <form class="row gy-2 gx-2 mb-3" method="get" action="{{ url_for('dashboard.index') }}">
          <div class="col-auto">
            <input type="number" class="form-control" placeholder="회차" name="round" value="{{ shops_round or '' }}" min="1">
          </div>
          <div class="col-auto">
            <button class="btn btn-primary">조회</button>
          </div>
        </form>
        {% if shops_round %}
          <h6 class="mb-2">{{ shops_round }}회 결과</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>#</th><th>상호명</th><th>소재지</th><th>판매구분</th></tr></thead>
              <tbody>
                {% for s in shops %}
                  <tr>
                    <td>{{ s.rank or '-' }}</td>
                    <td>{{ s.name }}</td>
                    <td>{{ s.address }}</td>
                    <td>{{ s.method }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if not shops %}
            <div class="text-muted">데이터가 없습니다.</div>
          {% endif %}
        {% else %}
          <div class="text-muted">조회할 회차를 입력해주세요.</div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}
