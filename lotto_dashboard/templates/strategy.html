{% extends "base.html" %}
{% block content %}

<div class="container">
  <h2 class="mb-4">전략 분석</h2>

  <!-- 추천 번호 섹션 -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title mb-0">AI 추천 번호</h4>
        <form method="post" action="{{ url_for('dashboard.refresh_recommend') }}">
          <button class="btn btn-primary">새로운 추천 생성</button>
        </form>
      </div>

      {% if not has_recommend %}
        <div class="alert alert-info">
          아직 이 회차에 대한 추천이 생성되지 않았습니다. <strong>새로운 추천 생성</strong> 버튼을 눌러 추천을 받아보세요.
        </div>
      {% else %}
        <div class="row">
          <div class="col-lg-6">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0">완전 추천 조합 (5세트)</h5>
              </div>
              <div class="card-body">
                {% for combo, reason in full_with_reason %}
                  <div class="mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-center mb-2">
                      {% for num in combo %}
                        <span class="badge bg-primary fs-6 me-1 px-3 py-2">{{ num }}</span>
                      {% endfor %}
                    </div>
                    <div class="small text-muted">
                      <strong>선택 이유:</strong> {{ reason }}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">반자동 조합 (5세트)</h5>
              </div>
              <div class="card-body">
                <p class="small text-muted mb-3">3개 번호는 추천되고, 나머지 3개는 직접 선택하세요.</p>
                {% for triple in semi %}
                  <div class="mb-3 p-3 border rounded">
                    <div class="d-flex align-items-center">
                      {% for num in triple %}
                        <span class="badge bg-success fs-6 me-1 px-3 py-2">{{ num }}</span>
                      {% endfor %}
                      <span class="text-muted ms-2">+ 자유선택 3개</span>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- 통계 분석 섹션 -->
  <div class="row g-4">
    <!-- 다빈출 번호 -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">다빈출 번호 TOP 20</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% set frequent_nums = [] %}
            {% for num in range(1, 46) %}
              {% if freqmap[num] > 0 %}
                {% set _ = frequent_nums.append((num, freqmap[num])) %}
              {% endif %}
            {% endfor %}
            {% set frequent_nums = frequent_nums|sort(attribute='1', reverse=True) %}

            {% for num, count in frequent_nums[:20] %}
              <div class="col-6 mb-2">
                <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                  <span class="badge bg-success px-2 py-1">{{ num }}</span>
                  <span class="small">{{ count }}회</span>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted">
              <strong>선택 기준:</strong> 최근 120회차 기준으로 가장 많이 나온 번호들입니다.
              통계적으로 자주 등장하는 번호들이지만, 과거 결과가 미래를 보장하지는 않습니다.
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- 저빈출 번호 -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">저빈출 번호 TOP 20</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% set rare_nums = frequent_nums|sort(attribute='1') %}

            {% for num, count in rare_nums[:20] %}
              <div class="col-6 mb-2">
                <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                  <span class="badge bg-secondary px-2 py-1">{{ num }}</span>
                  <span class="small">{{ count }}회</span>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted">
              <strong>선택 기준:</strong> 최근 120회차 기준으로 가장 적게 나온 번호들입니다.
              "언젠가는 나올 것"이라는 기대감으로 선택할 수 있지만, 확률론적으로는 동일합니다.
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- 최근 미출현 번호 -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">최근 미출현 번호 TOP 20</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% set cold_nums = [] %}
            {% for num in range(1, 46) %}
              {% set _ = cold_nums.append((num, lastmap[num])) %}
            {% endfor %}
            {% set cold_nums = cold_nums|sort(attribute='1', reverse=True) %}

            {% for num, weeks_ago in cold_nums[:20] %}
              <div class="col-6 mb-2">
                <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                  <span class="badge bg-danger px-2 py-1">{{ num }}</span>
                  <span class="small">{{ weeks_ago }}회 전</span>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted">
              <strong>선택 기준:</strong> 가장 오랫동안 나오지 않은 번호들입니다.
              "이제 나올 때가 되었다"는 심리적 기대를 반영하지만, 실제로는 매회 동일한 확률입니다.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 번호 조합 분석 -->
  <div class="card mt-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">잘 나오는 번호 조합 TOP 20</h5>
    </div>
    <div class="card-body">
      {% if pairs %}
        <div class="row">
          {% for pair, count in pairs[:20] %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
              <div class="card border-info">
                <div class="card-body text-center py-3">
                  <div class="mb-2">
                    <span class="badge bg-info fs-6 me-1 px-2 py-1">{{ pair[0] }}</span>
                    <span class="badge bg-info fs-6 px-2 py-1">{{ pair[1] }}</span>
                  </div>
                  <small class="text-muted">{{ count }}번 함께 출현</small>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="mt-3 p-3 bg-light rounded">
          <strong>분석 설명:</strong>
          <p class="mb-0 small text-muted">
            위의 조합들은 과거 당첨번호에서 함께 나온 빈도가 높은 번호 쌍들입니다.
            이러한 패턴은 순전히 우연의 결과일 수 있으며, 미래 당첨번호 예측에는 도움이 되지 않을 수 있습니다.
            하지만 번호 선택의 참고자료로 활용할 수 있습니다.
          </p>
        </div>
      {% else %}
        <div class="text-muted text-center py-5">
          충분한 데이터가 없어 조합 분석을 할 수 없습니다.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- 전략 요약 -->
  <div class="card mt-4">
    <div class="card-header bg-dark text-white">
      <h5 class="mb-0">전략 요약</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-primary">통계 기반 전략</h6>
          <ul>
            <li>다빈출 번호 위주의 안전한 선택</li>
            <li>저빈출 번호로 차별화된 조합 구성</li>
            <li>최근 미출현 번호의 반등 기대</li>
            <li>페어 조합을 활용한 상관관계 고려</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6 class="text-warning">주의사항</h6>
          <ul>
            <li>모든 번호는 매회 동일한 확률을 가집니다</li>
            <li>과거 패턴이 미래를 보장하지 않습니다</li>
            <li>분석은 참고용으로만 활용하세요</li>
            <li>책임감 있는 복권 구매를 권장합니다</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
